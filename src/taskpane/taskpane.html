<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>כלי ספרייה ודיקטה</title>
  <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 15px;
      background-color: #f8f9fa;
      direction: rtl;
    }
    
    .section {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    h2 {
      color: #2c3e50;
      text-align: center;
      margin-bottom: 30px;
    }
    
    h3 {
      color: #34495e;
      border-bottom: 2px solid #3498db;
      padding-bottom: 8px;
      margin-bottom: 15px;
    }
    
    button {
      background: linear-gradient(45deg, #3498db, #2980b9);
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      margin: 5px;
      transition: all 0.3s ease;
    }
    
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    button:disabled {
      background: #bdc3c7;
      cursor: not-allowed;
      transform: none;
    }
    
    .search-container {
      position: relative;
      margin-bottom: 15px;
    }
    
    input[type="text"] {
      width: 100%;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      box-sizing: border-box;
    }
    
    input[type="text"]:focus {
      outline: none;
      border-color: #3498db;
    }
    
    .dropdown-options {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #ddd;
      border-radius: 6px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .dropdown-option {
      padding: 10px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
    }
    
    .dropdown-option:hover {
      background-color: #f8f9fa;
    }
    
    .book-title {
      font-weight: bold;
      color: #2c3e50;
    }
    
    .book-subtitle {
      font-size: 12px;
      color: #7f8c8d;
    }
    
    .source-section {
      background: #f8f9fa;
      padding: 15px;
      margin: 10px 0;
      border-radius: 6px;
      cursor: pointer;
      border: 1px solid #e9ecef;
      transition: all 0.3s ease;
    }
    
    .source-section:hover {
      background: #e9ecef;
      transform: translateX(-5px);
    }
    
    .dicta-result {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      padding: 10px;
      margin: 5px 0;
      border-radius: 4px;
      cursor: pointer;
    }
    
    .dicta-result:hover {
      background: #ffeaa7;
    }
    
    .back-button {
      background: #95a5a6;
      margin-top: 15px;
    }
    
    .back-button:hover {
      background: #7f8c8d;
    }
    
    #output, #searchResults, #dictaResults {
      margin-top: 15px;
      padding: 10px;
      border-radius: 6px;
      min-height: 20px;
    }
    
    .success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .loading {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
  </style>
</head>
<body>
  <h2>כלי ספרייה ודיקטה לWord</h2>
  
  <!-- Section 1: Dicta citation detection -->
  <div class="section">
    <h3>זיהוי איזכורים בדיקטה</h3>
    <p>בחר טקסט במסמך ולחץ כדי למצוא איזכורים למקורות יהודיים</p>
    <button id="scanDicta">חפש איזכורים בדיקטה</button>
    <div id="dictaResults"></div>
  </div>
  
  <!-- Section 2: Sefaria scan -->
  <div class="section">
    <h3>זיהוי מקורות בספרייה</h3>
    <p>בחר טקסט במסמך ולחץ על הכפתור כדי לזהות מקורות והמירם לקישורים</p>
    <button id="scanText">סרוק טקסט ויצור קישורים</button>
    <div id="output"></div>
  </div>
  
  <!-- Section 3: Add new sources from Sefaria -->
  <div class="section">
    <h3>הוספת מקורות חדשים מספרייה</h3>
    <p>חפש ספר או מקור בספרייה והוסף אותו למסמך</p>
    <div class="search-container">
      <input type="text" id="sourceSearch" placeholder="הקלד שם ספר או מקור לחיפוש...">
      <div id="dropdownOptions" class="dropdown-options"></div>
      <button id="addSource">חפש</button>
    </div>
    <div id="searchResults"></div>
  </div>

  <script>
    // הגדרות דיקטה
    const DICTA_CONFIG = {
      serverUrl: 'https://talmudfinder-2-0.loadbalancer.dicta.org.il/TalmudFinder/api',
      timeout: 30000
    };

    // חיפוש איזכורים בדיקטה
    async function scanWithDicta() {
      try {
        await Word.run(async (context) => {
          const selection = context.document.getSelection();
          selection.load("text");
          await context.sync();

          if (!selection.text?.trim()) {
            showResult('dictaResults', 'לא נבחר טקסט', 'error');
            return;
          }

          showResult('dictaResults', 'מחפש איזכורים בדיקטה...', 'loading');

          // שלב 1: markpsukim - זיהוי ראשוני
          const markResponse = await fetch(`${DICTA_CONFIG.serverUrl}/markpsukim`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json'
            },
            body: JSON.stringify({
              mode: 'tanakh',
              thresh: 0,
              fdirectonly: false,
              data: selection.text
            })
          });

          if (!markResponse.ok) {
            throw new Error('שגיאה בחיפוש ראשוני');
          }

          const markData = await markResponse.json();
          
          if (!markData.results || markData.results.length === 0) {
            showResult('dictaResults', 'לא נמצאו איזכורים', 'error');
            return;
          }

          // שלב 2: parsetogroups - קבלת פרטים מלאים
          const parseResponse = await fetch(`${DICTA_CONFIG.serverUrl}/parsetogroups?smin=22&smax=10000`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json'
            },
            body: JSON.stringify(markData)
          });

          if (!parseResponse.ok) {
            throw new Error('שגיאה בעיבוד התוצאות');
          }

          const parseData = await parseResponse.json();
          displayDictaResults(parseData, selection.text);
        });
      } catch (error) {
        console.error('Dicta scan error:', error);
        showResult('dictaResults', `שגיאה: ${error.message}`, 'error');
      }
    }

    // הצגת תוצאות דיקטה
    function displayDictaResults(results, originalText) {
      const resultsDiv = document.getElementById('dictaResults');
      
      if (!results || results.length === 0) {
        showResult('dictaResults', 'לא נמצאו איזכורים', 'error');
        return;
      }

      let html = '<h4>נמצאו איזכורים:</h4>';
      
      results.forEach((group, groupIndex) => {
        if (group.matches && group.matches.length > 0) {
          html += `<div style="margin: 15px 0; padding: 10px; background: #f8f9fa; border-radius: 6px;">`;
          html += `<div style="font-weight: bold; margin-bottom: 8px;">קטע: "${group.text?.replace(/<[^>]*>/g, '') || 'ללא טקסט'}"</div>`;
          
          group.matches.forEach((match, matchIndex) => {
            const modeTitle = match.mode === 'Tanakh' ? 'תנ"ך' : 
                             match.mode === 'Mishna' ? 'משנה' : 
                             match.mode === 'Talmud' ? 'תלמוד' : match.mode;
            
            const ref = match.verseDispHeb || match.verseId || `${modeTitle} ${matchIndex + 1}`;
            const matchedText = match.matchedText?.replace(/<[^>]*>/g, '') || 'טקסט לא זמין';
            const score = match.score ? ` (${Math.round(match.score)}%)` : '';
            
            html += `<div class="dicta-result" onclick="insertDictaReference('${ref}', '${matchedText}', '${match.verseId}')">
              <strong>${modeTitle}: ${ref}${score}</strong><br>
              <span style="font-size: 0.9em; color: #666;">${matchedText.substring(0, 120)}...</span>
            </div>`;
          });
          
          html += `</div>`;
        }
      });

      resultsDiv.innerHTML = html;
      resultsDiv.className = 'success';
    }

    // הוספת הפניה מדיקטה למסמך
    async function insertDictaReference(ref, text, verseId) {
      try {
        await Word.run(async (context) => {
          const selection = context.document.getSelection();
          
          // יצירת קישור לספרייה בהתבסס על verseId
          let sefariaUrl = '';
          if (verseId) {
            // המרת verseId של דיקטה לפורמט ספרייה
            // דוגמה: "Tanakh.Writings.Job.37.21" -> "Job.37.21"
            const parts = verseId.split('.');
            if (parts.length >= 3) {
              const book = parts[parts.length - 3];
              const chapter = parts[parts.length - 2];
              const verse = parts[parts.length - 1];
              sefariaUrl = `https://www.sefaria.org/${book}.${chapter}.${verse}`;
            } else {
              sefariaUrl = `https://www.sefaria.org/${ref.replace(/\s+/g, '.')}`;
            }
          } else {
            sefariaUrl = `https://www.sefaria.org/${ref.replace(/\s+/g, '.')}`;
          }
          
          // הוספת ההפניה
          const referenceText = `\n[${ref}]`;
          const range = selection.insertText(referenceText, Word.InsertLocation.after);
          range.hyperlink = sefariaUrl;
          range.font.color = '#0066cc';
          
          await context.sync();
          
          showResult('dictaResults', `נוספה הפניה: ${ref}`, 'success');
        });
      } catch (error) {
        console.error('Insert reference error:', error);
        showResult('dictaResults', `שגיאה בהוספת הפניה: ${error.message}`, 'error');
      }
    }

    // פונקציות ספרייה (הקוד המקורי שלך)
    async function searchSefaria(query) {
      if (!query || query.length < 2) return null;
      
      try {
        const encodedQuery = encodeURIComponent(query);
        const response = await fetch(`https://www.sefaria.org/api/name/${encodedQuery}?ref_only=1&limit=10`, {
          method: 'GET',
          mode: 'cors',
          headers: { 'Accept': 'application/json' }
        });
        
        return response.ok ? await response.json() : null;
      } catch (error) {
        console.error("Search error:", error);
        return null;
      }
    }

    async function getSefariaText(ref) {
      try {
        const encodedRef = encodeURIComponent(ref);
        const response = await fetch(`https://www.sefaria.org/api/texts/${encodedRef}?stripItags=1`, {
          method: 'GET',
          mode: 'cors',
          headers: { 'Accept': 'application/json' }
        });
        
        if (response.ok) {
          return await response.json();
        }
      } catch (error) {
        console.error("Text fetch error:", error);
      }
      
      return {
        he: [`טקסט לדוגמה עבור ${ref}`],
        heRef: ref,
        ref: ref,
        url: ref.replace(/\s+/g, ".")
      };
    }

    function stripHtml(text) {
      return text ? text.replace(/<[^>]*>/g, "").replace(/&nbsp;/g, " ").trim() : "";
    }

    function showResult(elementId, message, type) {
      const element = document.getElementById(elementId);
      element.innerHTML = message;
      element.className = type;
    }

    async function showDropdown(query) {
      const dropdown = document.getElementById("dropdownOptions");
      
      if (!query || query.length < 2) {
        dropdown.style.display = "none";
        return;
      }

      dropdown.innerHTML = '<div class="dropdown-option">מחפש...</div>';
      dropdown.style.display = "block";

      const results = await searchSefaria(query);
      if (!results?.completion_objects?.length) {
        dropdown.innerHTML = '<div class="dropdown-option">לא נמצאו תוצאות</div>';
        return;
      }

      let options = "";

      if (results.is_ref && results.heAddressExamples && results.heAddressExamples.length > 0) {
        const bookTitle = results.ref || results.book || query;
        const bookTitleHe = results.completions[0] || bookTitle;
        
        options += `<div class="dropdown-option" onclick="selectFromDropdown('${results.key || results.ref}', '${bookTitleHe}')">
          <div class="book-title">${bookTitleHe}</div>
          <div class="book-subtitle">הספר כולו</div>
        </div>`;

        const maxExamples = Math.min(results.heAddressExamples.length, 5);
        for (let i = 0; i < maxExamples; i++) {
          const heAddress = results.heAddressExamples[i];
          const enAddress = results.addressExamples?.[i] || heAddress;
          const fullRefHe = `${bookTitleHe} ${heAddress}`;
          const fullKeyEn = `${results.key || results.ref} ${enAddress}`;
          
          options += `<div class="dropdown-option" onclick="selectFromDropdown('${fullKeyEn}', '${fullRefHe}')">
            <div class="book-title">${fullRefHe}</div>
            <div class="book-subtitle">פסוק/מקטע ספציפי</div>
          </div>`;
        }
      } else {
        options = results.completion_objects
          .filter(obj => obj.type === "ref" && obj.is_primary)
          .slice(0, 8)
          .map(opt => {
            const titleHe = opt.title || "ללא שם";
            const keyEn = opt.key || opt.title || "";
            return `<div class="dropdown-option" onclick="selectFromDropdown('${keyEn}', '${titleHe}')">
              <div class="book-title">${titleHe}</div>
              <div class="book-subtitle">${opt.type}</div>
            </div>`;
          }).join("");
      }

      dropdown.innerHTML = options || '<div class="dropdown-option">לא נמצאו ספרים מתאימים</div>';
    }

    function selectFromDropdown(key, displayName) {
      const searchInput = document.getElementById("sourceSearch");
      searchInput.value = displayName;
      searchInput.focus();
      hideDropdown();
    }

    function hideDropdown() {
      setTimeout(() => {
        const dropdown = document.getElementById("dropdownOptions");
        if (dropdown) {
          dropdown.style.display = "none";
        }
      }, 200);
    }

    async function scanTextForSources() {
      try {
        await Word.run(async (context) => {
          const selection = context.document.getSelection();
          selection.load("text");
          await context.sync();

          if (!selection.text?.trim()) {
            showResult('output', 'לא נבחר טקסט', 'error');
            return;
          }

          showResult('output', 'מחפש מקורות...', 'loading');

          const response = await fetch("https://www.sefaria.org/api/find-refs/", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              text: { body: selection.text, title: "" },
              lang: "he"
            })
          });

          if (!response.ok) throw new Error("שגיאה בשרת");

          const result = await response.json();
          const refs = result?.body?.results || [];

          if (!refs.length) {
            showResult('output', 'לא נמצאו מקורות', 'error');
            return;
          }

          let linksCreated = 0;
          for (const ref of refs) {
            try {
              const refKey = ref.refs[0];
              const refData = result.body.refData[refKey];
              if (!refData) continue;

              const url = "https://www.sefaria.org/" + (refData.url || refKey.replace(/\s+/g, "."));
              const refText = selection.text.substring(ref.startChar, ref.endChar);

              const searchResults = context.document.body.search(refText);
              searchResults.load("items");
              await context.sync();

              if (searchResults.items.length > 0) {
                searchResults.items[0].hyperlink = url;
                searchResults.items[0].font.color = "#0066cc";
                linksCreated++;
              }
            } catch (error) {
              console.error("Error processing ref:", error);
            }
          }

          showResult('output', 
            linksCreated > 0 ? `הומרו ${linksCreated} מקורות לקישורים` : 'לא ניתן היה ליצור קישורים',
            linksCreated > 0 ? 'success' : 'error'
          );

          await context.sync();
        });
      } catch (error) {
        console.error("Scan error:", error);
        showResult('output', `שגיאה: ${error.message}`, 'error');
      }
    }

    function showSourceText(textData, displayName) {
      let sourceHtml = `<h4>${textData.heRef || displayName}</h4><div class='source-sections'>`;
      
      if (Array.isArray(textData.he)) {
        textData.he.forEach((section, index) => {
          if (typeof section === "string" && section.trim()) {
            const cleanText = stripHtml(section);
            const preview = cleanText.substring(0, 150) + (cleanText.length > 150 ? "..." : "");
            const sectionTitle = `${textData.heRef || displayName} ${index + 1}`;
            
            sourceHtml += `<div class="source-section" onclick="insertSourceText('${textData.heRef || displayName}', ${index}, '${textData.heRef || displayName}', '${sectionTitle}')">
              <strong>${sectionTitle}:</strong> ${preview}
            </div>`;
          }
        });
      } else if (typeof textData.he === "string") {
        const preview = stripHtml(textData.he).substring(0, 200) + "...";
        sourceHtml += `<div class="source-section" onclick="insertSourceText('${textData.heRef || displayName}', 0, '${textData.heRef || displayName}', '${textData.heRef || displayName}')">
          ${preview}
        </div>`;
      }

      sourceHtml += `</div><button onclick="goBackToSearch()" class="back-button">חזור לחיפוש</button>`;
      document.getElementById("searchResults").innerHTML = sourceHtml;
    }

    async function searchSources() {
      const query = document.getElementById("sourceSearch").value.trim();
      if (!query) {
        showResult('searchResults', 'אנא הכנס מונח לחיפוש', 'error');
        return;
      }

      showResult('searchResults', 'מחפש...', 'loading');
      
      const nameResults = await searchSefaria(query);
      
      if (nameResults && nameResults.is_ref && nameResults.ref) {
        const textData = await getSefariaText(nameResults.ref);
        if (textData && (textData.he || textData.text)) {
          showSourceText(textData, nameResults.heRef || nameResults.ref);
          return;
        }
      }
      
      const textData = await getSefariaText(query);
      if (textData && (textData.he || textData.text)) {
        showSourceText(textData, query);
        return;
      }
      
      if (nameResults?.completion_objects?.length) {
        const resultsHtml = "<h4>בחר מקור:</h4>" + 
          nameResults.completion_objects
            .filter(obj => obj.type === "ref" && obj.is_primary)
            .slice(0, 8)
            .map(result => {
              const title = result.title || result.key || "ללא שם";
              const key = result.key || result.title || "";
              return `<div class="source-section" onclick="selectSource('${key}', '${title}')">
                ${title} (${result.type || 'ספר'})
              </div>`;
            }).join("");

        document.getElementById("searchResults").innerHTML = resultsHtml;
      } else {
        showResult('searchResults', 'לא נמצאו תוצאות', 'error');
      }
    }

    async function selectSource(key, displayText) {
      showResult('searchResults', 'טוען מקור...', 'loading');
      
      const textData = await getSefariaText(key);
      if (!textData) {
        showResult('searchResults', 'שגיאה בטעינת המקור', 'error');
        return;
      }

      showSourceText(textData, displayText);
    }

    async function insertSourceText(sourceKey, sectionIndex, displayName, sectionTitle) {
      try {
        await Word.run(async (context) => {
          const textData = await getSefariaText(sourceKey);
          if (!textData) throw new Error("לא ניתן לטעון את הטקסט");

          let textToInsert = "";
          if (Array.isArray(textData.he) && textData.he[sectionIndex]) {
            textToInsert = textData.he[sectionIndex];
          } else if (typeof textData.he === "string") {
            textToInsert = textData.he;
          }

          if (!textToInsert?.trim()) throw new Error("לא נמצא טקסט להוספה");

          const cleanText = stripHtml(textToInsert);
          const finalTitle = textData.heRef || sectionTitle || displayName;
          const sourceUrl = `https://www.sefaria.org/${textData.url || sourceKey.replace(/\s+/g, ".")}`;

          const selection = context.document.getSelection();
          
          selection.insertText(cleanText, Word.InsertLocation.after);
          
          const range = selection.getRange(Word.RangeLocation.after);
          const hyperlink = range.insertText(finalTitle, Word.InsertLocation.after);
          hyperlink.hyperlink = sourceUrl;
          
          const afterHyperlink = hyperlink.getRange(Word.RangeLocation.after);
          afterHyperlink.insertText("\n", Word.InsertLocation.after);
          
          await context.sync();

          showResult('searchResults', `הטקסט נוסף בהצלחה: ${finalTitle}`, 'success');
        });
      } catch (error) {
        console.error("Insert error:", error);
        showResult('searchResults', `שגיאה בהוספת הטקסט: ${error.message}`, 'error');
      }
    }

    function goBackToSearch() {
      document.getElementById("sourceSearch").value = "";
      document.getElementById("searchResults").innerHTML = "";
      hideDropdown();
    }

    // Make functions globally available
    window.insertDictaReference = insertDictaReference;
    window.selectFromDropdown = selectFromDropdown;
    window.selectSource = selectSource;
    window.insertSourceText = insertSourceText;
    window.goBackToSearch = goBackToSearch;

    // אתחול
    Office.onReady(() => {
      document.getElementById("scanDicta").onclick = scanWithDicta;
      document.getElementById("scanText").onclick = scanTextForSources;
      document.getElementById("addSource").onclick = searchSources;

      const searchInput = document.getElementById("sourceSearch");
      searchInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          hideDropdown();
          searchSources();
        }
      });
      
      searchInput.addEventListener("focus", (e) => showDropdown(e.target.value));
      searchInput.addEventListener("input", (e) => showDropdown(e.target.value));
      searchInput.addEventListener("blur", (e) => {
        setTimeout(() => hideDropdown(), 300);
      });

      document.addEventListener("click", (e) => {
        if (!e.target.closest(".search-container") && !e.target.closest("#dropdownOptions")) {
          hideDropdown();
        }
      });
    });
  </script>
</body>
</html>